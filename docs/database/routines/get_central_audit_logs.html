<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>gis Database</title>
        <!-- Tell the browser to be responsive to screen width -->
        <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
        <link rel="icon" type="image/png" sizes="16x16" href="../favicon.png">
        <!-- Bootstrap 3.3.5 -->
        <link rel="stylesheet" href="../bower/admin-lte/bootstrap/css/bootstrap.min.css">
        <!-- Font Awesome -->
        <link rel="stylesheet" href="../bower/font-awesome/css/font-awesome.min.css">
        <!-- Ionicons -->
        <link rel="stylesheet" href="../bower/ionicons/css/ionicons.min.css">
        <!-- DataTables -->
        <link rel="stylesheet" href="../bower/datatables.net-bs/css/dataTables.bootstrap.min.css">
        <link rel="stylesheet" href="../bower/datatables.net-buttons-bs/css/buttons.bootstrap.min.css">
        <!-- Code Mirror -->
        <link rel="stylesheet" href="../bower/codemirror/codemirror.css">
        <!-- Fonts -->
        <link href='../fonts/indieflower/indie-flower.css' rel='stylesheet' type='text/css'>
        <link href='../fonts/source-sans-pro/source-sans-pro.css' rel='stylesheet' type='text/css'>

        <!-- Theme style -->
        <link rel="stylesheet" href="../bower/admin-lte/dist/css/AdminLTE.min.css">
        <!-- Salvattore -->
        <link rel="stylesheet" href="../bower/salvattore/salvattore.css">
        <!-- AdminLTE Skins. Choose a skin from the css/skins
           folder instead of downloading all of them to reduce the load. -->
        <link rel="stylesheet" href="../bower/admin-lte/dist/css/skins/_all-skins.min.css">
        <!-- SchemaSpy -->
        <link rel="stylesheet" href="../schemaSpy.css">

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
        <script src="../bower/html5shiv/html5shiv.min.js"></script>
        <script src="../bower/respond/respond.min.js"></script>
        <![endif]-->
    </head>
    <!-- ADD THE CLASS layout-top-nav TO REMOVE THE SIDEBAR. -->
    <body class="hold-transition skin-blue layout-top-nav">
        <div class="wrapper">
            <header class="main-header">
                <nav class="navbar navbar-static-top">
                    <div class="container">
                        <div class="navbar-header">
                            <a href="../index.html" class="navbar-brand"><b>gis</b> Database</a>
                            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse"><i class="fa fa-bars"></i></button>
                        </div>

                        <!-- Collect the nav links, forms, and other content for toggling -->
                        <div class="collapse navbar-collapse pull-left" id="navbar-collapse">
                            <ul class="nav navbar-nav">
                                <li><a href="../index.html">Tables <span class="sr-only">(current)</span></a></li>
                                <li><a href="../columns.html" title="All of the columns in the schema">Columns</a></li>
                                <li><a href="../constraints.html" title="Useful for diagnosing error messages that just give constraint name or number">Constraints</a></li>
                                <li><a href="../relationships.html" title="Diagram of table relationships">Relationships</a></li>
                                <li><a href="../orphans.html" title="View of tables with neither parents nor children">Orphan&nbsp;Tables</a></li>
                                <li><a href="../anomalies.html" title="Things that might not be quite right">Anomalies</a></li>
                                <li><a href="../routines.html" title="Procedures and functions">Routines</a></li>
                            </ul>
                        </div>
                        <!-- /.navbar-collapse -->
                        <!-- Navbar Right Menu -->
                    </div>
                    <!-- /.container-fluid -->
                </nav>
            </header>
            <!-- Main content -->
            <!-- Full Width Column -->
            <div class="content-wrapper">
                <!-- Content Header (Page header) -->
                <section class="content-header">
                    <h1>get_central_audit_logs</h1><br />
                    <div class="box box-primary">
                        <div class="box-header with-border">
                            <i class="fa fa-file-text-o"></i>
                            <h3 id="Description" class="box-title">Description</h3>
                            <div class="box-tools pull-right">
                                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                                <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
                            </div>
                        </div>
                        <!-- /.box-header -->
                        <div class="box-body clearfix">
                            <p><p>Get all the logs from the central database: modifications do not come from the clone, have not yet been replayed by the clone, are dated after the last synchronization, have an event id higher than the last sync maximum event id, and concern the synchronized tables for this clone. Parameters: uid column name and excluded columns</p></p>
                        </div>
                        <!-- /.box-body -->
                    </div>
                </section>
                <!-- Main content -->
                <section class="content">
                    <div class="box box-primary">
                        <div class="box-header with-border">
                            <span class="glyphicon glyphicon-list-alt" aria-hidden="true"></span>
                            <h3 id="Columns" class="box-title">Parameters</h3>
                            <div class="box-tools pull-right">
                                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                                <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
                            </div>
                        </div>
                        <div class="box-body">
                            <table id="standard_table" class="table table-bordered table-striped dataTable" role="grid">
                                <thead align='left'>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Mode</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td>p_uid_field</td>
                                    <td>text</td>
                                    <td>IN</td>
                                </tr>
                                <tr>
                                    <td>p_excluded_columns</td>
                                    <td>ARRAY</td>
                                    <td>IN</td>
                                </tr>
                                <tr>
                                    <td>event_id</td>
                                    <td>bigint</td>
                                    <td>OUT</td>
                                </tr>
                                <tr>
                                    <td>action_tstamp_tx</td>
                                    <td>timestamp with time zone</td>
                                    <td>OUT</td>
                                </tr>
                                <tr>
                                    <td>action_tstamp_epoch</td>
                                    <td>integer</td>
                                    <td>OUT</td>
                                </tr>
                                <tr>
                                    <td>ident</td>
                                    <td>text</td>
                                    <td>OUT</td>
                                </tr>
                                <tr>
                                    <td>action_type</td>
                                    <td>text</td>
                                    <td>OUT</td>
                                </tr>
                                <tr>
                                    <td>origine</td>
                                    <td>text</td>
                                    <td>OUT</td>
                                </tr>
                                <tr>
                                    <td>action</td>
                                    <td>text</td>
                                    <td>OUT</td>
                                </tr>
                                <tr>
                                    <td>updated_field</td>
                                    <td>text</td>
                                    <td>OUT</td>
                                </tr>
                                <tr>
                                    <td>uid</td>
                                    <td>uuid</td>
                                    <td>OUT</td>
                                </tr>
                                <tr>
                                    <td>original_action_tstamp_tx</td>
                                    <td>integer</td>
                                    <td>OUT</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="box box-primary">
                        <div class="box-header with-border">
                            <i class="fa fa-file-code-o"></i>
                            <h3 id="RoutineDefinition" class="box-title">Definition</h3>
                            <div class="box-tools pull-right">
                                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                                <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
                            </div>
                        </div>
                        <div class="box-body">
                            <textarea id="sql-script-codemirror" name="sql-script-codemirror" rows="" style="display: none;">&#10;DECLARE&#10;    p_clone_id text;&#10;    p_excluded_columns_text text;&#10;    sqltemplate text;&#10;    sqltext text;&#10;    dblink_connection_name text;&#10;    dblink_msg text;&#10;BEGIN&#10;&#10;    IF p_excluded_columns IS NULL THEN&#10;        p_excluded_columns_text = &#39;&#39;;&#10;    ELSE&#10;        p_excluded_columns_text = array_to_string(p_excluded_columns, &#39;@&#39;);&#10;    END IF;&#10;&#10;    -- Get clone server id&#10;    SELECT server_id::text INTO p_clone_id&#10;    FROM lizsync.server_metadata&#10;    LIMIT 1;&#10;&#10;    IF p_clone_id IS NULL THEN&#10;        RETURN QUERY&#10;        SELECT&#10;            NULL, NULL, NULL, NULL,&#10;            NULL, NULL, NULL, NULL, NULL, NULL&#10;        LIMIT 0;&#10;    END IF;&#10;&#10;    -- Create dblink connection&#10;    dblink_connection_name = (md5(((random())::text || (clock_timestamp())::text)))::text;&#10;    SELECT dblink_connect(&#10;        dblink_connection_name,&#10;        &#39;central_server&#39;&#10;    )&#10;    INTO dblink_msg;&#10;&#10;    sqltemplate = &#39;&#10;&#10;        WITH&#10;        cid AS (&#10;            SELECT server_id::text AS p_central_id&#10;            FROM lizsync.server_metadata&#10;            LIMIT 1&#10;        ),&#10;        last_sync AS (&#10;            SELECT&#10;                max_action_tstamp_tx,&#10;                max_event_id&#10;            FROM lizsync.history&#10;            WHERE True&#10;            AND server_from = (SELECT p_central_id FROM cid)&#10;            AND &#39;&#39;%1$s&#39;&#39; = ANY (server_to)&#10;            AND sync_status = &#39;&#39;done&#39;&#39;&#10;            ORDER BY sync_time DESC&#10;            LIMIT 1&#10;        ),&#10;        tables AS (&#10;            SELECT sync_tables&#10;            FROM lizsync.synchronized_tables&#10;            WHERE server_id = &#39;&#39;%1$s&#39;&#39;::uuid&#10;            LIMIT 1&#10;        )&#10;        SELECT&#10;            a.event_id,&#10;            a.action_tstamp_tx AS action_tstamp_tx,&#10;            extract(epoch from a.action_tstamp_tx)::integer AS action_tstamp_epoch,&#10;            concat(a.schema_name, &#39;&#39;.&#39;&#39;, a.table_name) AS ident,&#10;            a.action AS action_type,&#10;            CASE&#10;                WHEN a.sync_data-&gt;&gt;&#39;&#39;origin&#39;&#39; IS NULL THEN &#39;&#39;central&#39;&#39;&#10;                ELSE &#39;&#39;clone&#39;&#39;&#10;            END AS origine,&#10;            Coalesce(&#10;                lizsync.get_event_sql(&#10;                    a.event_id,&#10;                    &#39;&#39;%2$s&#39;&#39;::text,&#10;                    array_cat(&#10;                        string_to_array(&#39;&#39;%3$s&#39;&#39;,&#39;&#39;@&#39;&#39;),&#10;                        array_remove(akeys(a.changed_fields), s)&#10;                    )&#10;                ),&#10;                &#39;&#39;&#39;&#39;&#10;            ) AS action,&#10;            s AS updated_field,&#10;            (a.row_data-&gt;&#39;&#39;%2$s&#39;&#39;)::uuid AS uid,&#10;            CASE&#10;                WHEN a.sync_data-&gt;&gt;&#39;&#39;action_tstamp_tx&#39;&#39; IS NOT NULL&#10;                AND a.sync_data-&gt;&gt;&#39;&#39;origin&#39;&#39; IS NOT NULL&#10;                    THEN extract(epoch from Cast(a.sync_data-&gt;&gt;&#39;&#39;action_tstamp_tx&#39;&#39; AS TIMESTAMP WITH TIME ZONE))::integer&#10;                ELSE extract(epoch from a.action_tstamp_tx)::integer&#10;            END AS original_action_tstamp_tx&#10;        FROM audit.logged_actions AS a&#10;        -- Create as many lines as there are changed fields in UPDATE&#10;        LEFT JOIN skeys(a.changed_fields) AS s ON TRUE,&#10;        last_sync, tables&#10;&#10;        WHERE True&#10;&#10;        -- modifications do not come from clone database&#10;        AND (a.sync_data-&gt;&gt;&#39;&#39;origin&#39;&#39; != &#39;&#39;%1$s&#39;&#39; OR a.sync_data-&gt;&gt;&#39;&#39;origin&#39;&#39; IS NULL)&#10;&#10;        -- modifications have not yet been replayed in the clone database&#10;        AND (NOT (a.sync_data-&gt;&#39;&#39;replayed_by&#39;&#39; ? &#39;&#39;%1$s&#39;&#39;) OR a.sync_data-&gt;&#39;&#39;replayed_by&#39;&#39; = jsonb_build_object() )&#10;&#10;        -- modifications after the last synchronization&#10;        -- MAX_ACTION_TSTAMP_TX Par ex: 2019-04-20 12:00:00+02&#10;        AND a.action_tstamp_tx &gt; last_sync.max_action_tstamp_tx&#10;&#10;        -- Event ID is bigger than last sync event id&#10;        -- MAX_EVENT_ID&#10;        AND a.event_id &gt; last_sync.max_event_id&#10;&#10;        -- only for tables synchronized by the clone server ID&#10;        AND sync_tables ? concat(&#39;&#39;&quot;&#39;&#39;, a.schema_name, &#39;&#39;&quot;.&quot;&#39;&#39;, a.table_name, &#39;&#39;&quot;&#39;&#39;)&#10;&#10;        ORDER BY a.event_id&#10;        ;&#10;    &#39;;&#10;&#10;    sqltext = format(sqltemplate,&#10;        p_clone_id,&#10;        p_uid_field,&#10;        p_excluded_columns_text&#10;    );&#10;    --RAISE NOTICE &#39;%&#39;, sqltext;&#10;&#10;    RETURN QUERY&#10;    SELECT *&#10;    FROM dblink(&#10;        dblink_connection_name,&#10;        sqltext&#10;    ) AS t(&#10;        event_id bigint, action_tstamp_tx timestamp with time zone, action_tstamp_epoch integer,&#10;        ident text, action_type text, origine text, action text, updated_field text,&#10;        uid uuid, original_action_tstamp_tx integer&#10;    )&#10;    ;&#10;&#10;END;&#10;</textarea>
                        </div>
                    </div>
                </section>
            </div>
            <!-- /.content-wrapper -->
            <footer class="main-footer">
                <div>
                    <div class="pull-right hidden-xs">
                        <a href="https://github.com/schemaspy/schemaspy" title="GitHub for SchemaSpy"><i class="fa fa-github-square fa-2x"></i></a>
                        <a href="http://stackoverflow.com/questions/tagged/schemaspy" title="StackOverflow for SchemaSpy"><i class="fa fa-stack-overflow fa-2x"></i></a>
                    </div>
                    <strong>Generated by <a href="http://schemaspy.org/" class="logo-text"><i class="fa fa-database"></i> SchemaSpy 6.1.0</a></strong>
                </div>
                <!-- /.container -->
            </footer>
        </div>
        <!-- ./wrapper -->

        <!-- jQuery 2.2.3 -->
        <script src="../bower/admin-lte/plugins/jQuery/jquery-2.2.3.min.js"></script>
        <script src="../bower/admin-lte/plugins/jQueryUI/jquery-ui.min.js"></script>
        <!-- Bootstrap 3.3.5 -->
        <script src="../bower/admin-lte/bootstrap/js/bootstrap.min.js"></script>
        <!-- DataTables -->
        <script src="../bower/datatables.net/jquery.dataTables.min.js"></script>
        <script src="../bower/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
        <script src="../bower/datatables.net-buttons/dataTables.buttons.min.js"></script>
        <script src="../bower/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
        <script src="../bower/datatables.net-buttons/buttons.html5.min.js"></script>
        <script src="../bower/datatables.net-buttons/buttons.print.min.js"></script>
        <script src="../bower/datatables.net-buttons/buttons.colVis.min.js"></script>
        <!-- SheetJS -->
        <script src="../bower/js-xlsx/xlsx.full.min.js"></script>
        <!-- pdfmake -->
        <script src="../bower/pdfmake/pdfmake.min.js"></script>
        <script src="../bower/pdfmake/vfs_fonts.js"></script>
        <!-- SlimScroll -->
        <script src="../bower/admin-lte/plugins/slimScroll/jquery.slimscroll.min.js"></script>
        <!-- FastClick -->
        <script src="../bower/admin-lte/plugins/fastclick/fastclick.js"></script>
        <!-- Salvattore -->
        <script src="../bower/salvattore/salvattore.min.js"></script>
        <!-- AnchorJS -->
        <script src="../bower/anchor-js/anchor.min.js"></script>
        <!-- CodeMirror -->
        <script src="../bower/codemirror/codemirror.js"></script>
        <script src="../bower/codemirror/sql.js"></script>
        <!-- AdminLTE App -->
        <script src="../bower/admin-lte/dist/js/app.min.js"></script>
        <script src="routine.js"></script>
        <script src="../schemaSpy.js"></script>
    </body>
</html>