<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>gis Database</title>
        <!-- Tell the browser to be responsive to screen width -->
        <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
        <link rel="icon" type="image/png" sizes="16x16" href="../favicon.png">
        <!-- Bootstrap 3.3.5 -->
        <link rel="stylesheet" href="../bower/admin-lte/bootstrap/css/bootstrap.min.css">
        <!-- Font Awesome -->
        <link rel="stylesheet" href="../bower/font-awesome/css/font-awesome.min.css">
        <!-- Ionicons -->
        <link rel="stylesheet" href="../bower/ionicons/css/ionicons.min.css">
        <!-- DataTables -->
        <link rel="stylesheet" href="../bower/datatables.net-bs/css/dataTables.bootstrap.min.css">
        <link rel="stylesheet" href="../bower/datatables.net-buttons-bs/css/buttons.bootstrap.min.css">
        <!-- Code Mirror -->
        <link rel="stylesheet" href="../bower/codemirror/codemirror.css">
        <!-- Fonts -->
        <link href='../fonts/indieflower/indie-flower.css' rel='stylesheet' type='text/css'>
        <link href='../fonts/source-sans-pro/source-sans-pro.css' rel='stylesheet' type='text/css'>

        <!-- Theme style -->
        <link rel="stylesheet" href="../bower/admin-lte/dist/css/AdminLTE.min.css">
        <!-- Salvattore -->
        <link rel="stylesheet" href="../bower/salvattore/salvattore.css">
        <!-- AdminLTE Skins. Choose a skin from the css/skins
           folder instead of downloading all of them to reduce the load. -->
        <link rel="stylesheet" href="../bower/admin-lte/dist/css/skins/_all-skins.min.css">
        <!-- SchemaSpy -->
        <link rel="stylesheet" href="../schemaSpy.css">

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
        <script src="../bower/html5shiv/html5shiv.min.js"></script>
        <script src="../bower/respond/respond.min.js"></script>
        <![endif]-->
    </head>
    <!-- ADD THE CLASS layout-top-nav TO REMOVE THE SIDEBAR. -->
    <body class="hold-transition skin-blue layout-top-nav">
        <div class="wrapper">
            <header class="main-header">
                <nav class="navbar navbar-static-top">
                    <div class="container">
                        <div class="navbar-header">
                            <a href="../index.html" class="navbar-brand"><b>gis</b> Database</a>
                            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse"><i class="fa fa-bars"></i></button>
                        </div>

                        <!-- Collect the nav links, forms, and other content for toggling -->
                        <div class="collapse navbar-collapse pull-left" id="navbar-collapse">
                            <ul class="nav navbar-nav">
                                <li><a href="../index.html">Tables <span class="sr-only">(current)</span></a></li>
                                <li><a href="../columns.html" title="All of the columns in the schema">Columns</a></li>
                                <li><a href="../constraints.html" title="Useful for diagnosing error messages that just give constraint name or number">Constraints</a></li>
                                <li><a href="../relationships.html" title="Diagram of table relationships">Relationships</a></li>
                                <li><a href="../orphans.html" title="View of tables with neither parents nor children">Orphan&nbsp;Tables</a></li>
                                <li><a href="../anomalies.html" title="Things that might not be quite right">Anomalies</a></li>
                                <li><a href="../routines.html" title="Procedures and functions">Routines</a></li>
                            </ul>
                        </div>
                        <!-- /.navbar-collapse -->
                        <!-- Navbar Right Menu -->
                    </div>
                    <!-- /.container-fluid -->
                </nav>
            </header>
            <!-- Main content -->
            <!-- Full Width Column -->
            <div class="content-wrapper">
                <!-- Content Header (Page header) -->
                <section class="content-header">
                    <h1>if_modified_func</h1><br />
                    <div class="box box-primary">
                        <div class="box-header with-border">
                            <i class="fa fa-file-text-o"></i>
                            <h3 id="Description" class="box-title">Description</h3>
                            <div class="box-tools pull-right">
                                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                                <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
                            </div>
                        </div>
                        <!-- /.box-header -->
                        <div class="box-body clearfix">
                            <p><p>Track changes to a table at the statement and/or row level.</p>
<p>Optional parameters to trigger in CREATE TRIGGER call:</p>
<p>param 0: boolean, whether to log the query text. Default &lsquo;t&rsquo;.</p>
<p>param 1: text[], columns to ignore in updates. Default [].</p>
<pre><code>     Updates to ignored cols are omitted from changed_fields.

     Updates with only ignored cols changed are not inserted
     into the audit log.

     Almost all the processing work is still done for updates
     that ignored. If you need to save the load, you need to use
     WHEN clause on the trigger instead.

     No warning or error is issued if ignored_cols contains columns
     that do not exist in the target table. This lets you specify
     a standard set of ignored columns.
</code></pre>
<p>There is no parameter to disable logging of values. Add this trigger as<br />
a &lsquo;FOR EACH STATEMENT&rsquo; rather than &lsquo;FOR EACH ROW&rsquo; trigger if you do not<br />
want to log row values.</p>
<p>Note that the user name logged is the login role for the session. The audit trigger<br />
cannot obtain the active role because it is reset by the SECURITY DEFINER invocation<br />
of the audit trigger its self.</p>
<p>LizSync has added its own sync_data column to store the needed information for synchronisation purpose.</p>
<p>[]: ./../null<br />
[]: ./../null</p></p>
                        </div>
                        <!-- /.box-body -->
                    </div>
                </section>
                <!-- Main content -->
                <section class="content">
                    <div class="box box-primary">
                        <div class="box-header with-border">
                            <span class="glyphicon glyphicon-list-alt" aria-hidden="true"></span>
                            <h3 id="Columns" class="box-title">Parameters</h3>
                            <div class="box-tools pull-right">
                                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                                <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
                            </div>
                        </div>
                        <div class="box-body">
                            <table id="standard_table" class="table table-bordered table-striped dataTable" role="grid">
                                <thead align='left'>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Mode</th>
                                </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="box box-primary">
                        <div class="box-header with-border">
                            <i class="fa fa-file-code-o"></i>
                            <h3 id="RoutineDefinition" class="box-title">Definition</h3>
                            <div class="box-tools pull-right">
                                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                                <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
                            </div>
                        </div>
                        <div class="box-body">
                            <textarea id="sql-script-codemirror" name="sql-script-codemirror" rows="" style="display: none;">&#10;DECLARE&#10;    audit_row lizsync.logged_actions;&#10;    include_values boolean;&#10;    log_diffs boolean;&#10;    h_old hstore;&#10;    h_new hstore;&#10;    excluded_cols text[] = ARRAY[]::text[];&#10;BEGIN&#10;    --RAISE WARNING &#39;[lizsync.if_modified_func] start with TG_ARGV[0]: % ; TG_ARGV[1] : %, TG_OP: %, TG_LEVEL : %, TG_WHEN: % &#39;, TG_ARGV[0], TG_ARGV[1], TG_OP, TG_LEVEL, TG_WHEN;&#10;&#10;    IF NOT (TG_WHEN IN (&#39;AFTER&#39; , &#39;INSTEAD OF&#39;)) THEN&#10;        RAISE EXCEPTION &#39;lizsync.if_modified_func() may only run as an AFTER trigger&#39;;&#10;    END IF;&#10;&#10;    audit_row = ROW(&#10;        nextval(&#39;lizsync.logged_actions_event_id_seq&#39;), -- event_id&#10;        TG_TABLE_SCHEMA::text,                        -- schema_name&#10;        TG_TABLE_NAME::text,                          -- table_name&#10;        TG_RELID,                                     -- relation OID for much quicker searches&#10;        session_user::text,                           -- session_user_name&#10;        current_timestamp,                            -- action_tstamp_tx&#10;        statement_timestamp(),                        -- action_tstamp_stm&#10;        clock_timestamp(),                            -- action_tstamp_clk&#10;        txid_current(),                               -- transaction ID&#10;        (SELECT setting FROM pg_settings WHERE name = &#39;application_name&#39;),&#10;        inet_client_addr(),                           -- client_addr&#10;        inet_client_port(),                           -- client_port&#10;        current_query(),                              -- top-level query or queries (if multistatement) from client&#10;        substring(TG_OP,1,1),                         -- action&#10;        NULL, NULL,                                   -- row_data, changed_fields&#10;        &#39;f&#39;,                                          -- statement_only&#10;&#10;        -- LizSync specific data field&#10;        jsonb_build_object(&#10;            &#39;origin&#39;, current_setting(&#39;lizsync.server_from&#39;, true),&#10;            &#39;replayed_by&#39;,&#10;            CASE&#10;                WHEN current_setting(&#39;lizsync.server_to&#39;, true) IS NOT NULL&#10;                AND current_setting(&#39;lizsync.sync_id&#39;, true) IS NOT NULL&#10;                    THEN jsonb_build_object(&#10;                        current_setting(&#39;lizsync.server_to&#39;, true),&#10;                        current_setting(&#39;lizsync.sync_id&#39;, true)&#10;                    )&#10;                ELSE jsonb_build_object()&#10;            END,&#10;            -- when the clone has created/updated/deleted the data in the clone database&#10;            &#39;action_tstamp_tx&#39;,&#10;            Cast(current_setting(&#39;lizsync.clone_action_tstamp_tx&#39;, true) AS TIMESTAMP WITH TIME ZONE)&#10;        )&#10;    );&#10;&#10;    IF NOT TG_ARGV[0]::boolean IS DISTINCT FROM &#39;f&#39;::boolean THEN&#10;        audit_row.client_query = NULL;&#10;        RAISE WARNING &#39;[lizsync.if_modified_func] - Trigger func triggered with no client_query tracking&#39;;&#10;&#10;    END IF;&#10;&#10;    IF TG_ARGV[1] IS NOT NULL THEN&#10;        excluded_cols = TG_ARGV[1]::text[];&#10;        RAISE WARNING &#39;[lizsync.if_modified_func] - Trigger func triggered with excluded_cols: %&#39;,TG_ARGV[1];&#10;    END IF;&#10;&#10;    IF (TG_OP = &#39;UPDATE&#39; AND TG_LEVEL = &#39;ROW&#39;) THEN&#10;        h_old = hstore(OLD.*) - excluded_cols;&#10;        audit_row.row_data = h_old;&#10;        h_new = hstore(NEW.*)- excluded_cols;&#10;        audit_row.changed_fields =  h_new - h_old;&#10;&#10;        IF audit_row.changed_fields = hstore(&#39;&#39;) THEN&#10;            -- All changed fields are ignored. Skip this update.&#10;            RAISE WARNING &#39;[lizsync.if_modified_func] - Trigger detected NULL hstore. ending&#39;;&#10;            RETURN NULL;&#10;        END IF;&#10;  INSERT INTO lizsync.logged_actions VALUES (audit_row.*);&#10;  RETURN NEW;&#10;&#10;    ELSIF (TG_OP = &#39;DELETE&#39; AND TG_LEVEL = &#39;ROW&#39;) THEN&#10;        audit_row.row_data = hstore(OLD.*) - excluded_cols;&#10;  INSERT INTO lizsync.logged_actions VALUES (audit_row.*);&#10;        RETURN OLD;&#10;&#10;    ELSIF (TG_OP = &#39;INSERT&#39; AND TG_LEVEL = &#39;ROW&#39;) THEN&#10;        audit_row.row_data = hstore(NEW.*) - excluded_cols;&#10;  INSERT INTO lizsync.logged_actions VALUES (audit_row.*);&#10;        RETURN NEW;&#10;&#10;    ELSIF (TG_LEVEL = &#39;STATEMENT&#39; AND TG_OP IN (&#39;INSERT&#39;,&#39;UPDATE&#39;,&#39;DELETE&#39;,&#39;TRUNCATE&#39;)) THEN&#10;        audit_row.statement_only = &#39;t&#39;;&#10;        INSERT INTO lizsync.logged_actions VALUES (audit_row.*);&#10;  RETURN NULL;&#10;&#10;    ELSE&#10;        RAISE EXCEPTION &#39;[lizsync.if_modified_func] - Trigger func added as trigger for unhandled case: %, %&#39;,TG_OP, TG_LEVEL;&#10;        RETURN NEW;&#10;    END IF;&#10;&#10;&#10;END;&#10;</textarea>
                        </div>
                    </div>
                </section>
            </div>
            <!-- /.content-wrapper -->
            <footer class="main-footer">
                <div>
                    <div class="pull-right hidden-xs">
                        <a href="https://github.com/schemaspy/schemaspy" title="GitHub for SchemaSpy"><i class="fa fa-github-square fa-2x"></i></a>
                        <a href="http://stackoverflow.com/questions/tagged/schemaspy" title="StackOverflow for SchemaSpy"><i class="fa fa-stack-overflow fa-2x"></i></a>
                    </div>
                    <strong>Generated by <a href="http://schemaspy.org/" class="logo-text"><i class="fa fa-database"></i> SchemaSpy 6.1.0</a></strong>
                </div>
                <!-- /.container -->
            </footer>
        </div>
        <!-- ./wrapper -->

        <!-- jQuery 2.2.3 -->
        <script src="../bower/admin-lte/plugins/jQuery/jquery-2.2.3.min.js"></script>
        <script src="../bower/admin-lte/plugins/jQueryUI/jquery-ui.min.js"></script>
        <!-- Bootstrap 3.3.5 -->
        <script src="../bower/admin-lte/bootstrap/js/bootstrap.min.js"></script>
        <!-- DataTables -->
        <script src="../bower/datatables.net/jquery.dataTables.min.js"></script>
        <script src="../bower/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
        <script src="../bower/datatables.net-buttons/dataTables.buttons.min.js"></script>
        <script src="../bower/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
        <script src="../bower/datatables.net-buttons/buttons.html5.min.js"></script>
        <script src="../bower/datatables.net-buttons/buttons.print.min.js"></script>
        <script src="../bower/datatables.net-buttons/buttons.colVis.min.js"></script>
        <!-- SheetJS -->
        <script src="../bower/js-xlsx/xlsx.full.min.js"></script>
        <!-- pdfmake -->
        <script src="../bower/pdfmake/pdfmake.min.js"></script>
        <script src="../bower/pdfmake/vfs_fonts.js"></script>
        <!-- SlimScroll -->
        <script src="../bower/admin-lte/plugins/slimScroll/jquery.slimscroll.min.js"></script>
        <!-- FastClick -->
        <script src="../bower/admin-lte/plugins/fastclick/fastclick.js"></script>
        <!-- Salvattore -->
        <script src="../bower/salvattore/salvattore.min.js"></script>
        <!-- AnchorJS -->
        <script src="../bower/anchor-js/anchor.min.js"></script>
        <!-- CodeMirror -->
        <script src="../bower/codemirror/codemirror.js"></script>
        <script src="../bower/codemirror/sql.js"></script>
        <!-- AdminLTE App -->
        <script src="../bower/admin-lte/dist/js/app.min.js"></script>
        <script src="routine.js"></script>
        <script src="../schemaSpy.js"></script>
    </body>
</html>